---
title: "HackDuke"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)}
if(!require(tidyverse)) {install.packages("tidyverse"); library(tidyverse)}
if(!require(rvest)) {install.packages("rvest"); library(rvest)}
if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)}
if(!require(wdman)) {install.packages("wdman"); library(wdman)}
if(!require(netstat)) {install.packages("netstat"); library(netstat)}
if(!require(xml2)) {install.packages("xml2"); library(xml2)}
if(!require(webdriver)) {install.packages("webdriver"); library(webdriver)}
if(!require(purrr)) {install.packages("purrr"); library(purrr)}
if (!require(here)) {install.packages("here"); library(here)}
if (!require(dotenv)) {install.packages("dotenv"); library(dotenv)}
if (!require(ggplot2)) {install.packages("ggplot2"); library(ggplot2)}
```

```{r data}
#data <- read.csv("./data/responses.csv")
#sample_data_responses <- read.csv("./sample_data/responses.csv")
sample_data_responses <- read.csv("./Data Files/responses.csv")
#sample_data_mediaviews <- read.csv("./sample_data/media_views.csv")
sample_data_mediaviews <- read.csv("./Data Files/media_views.csv")
df <- read.csv("./Data Files/page_views.csv")
```

```{r}
### Informed EDA

sample_rows_with_non_na <- apply(sample_data_responses[, 29:40], 1, function(x) any(!is.na(x)))
sample_filtered_data <- sample_data_responses[sample_rows_with_non_na, ]
lrn_type_counts <- table(sample_data_responses$lrn_type)
# Convert the table to a dataframe for ggplot2
lrn_type_counts_df <- as.data.frame(lrn_type_counts)

# Rename the columns for clarity
names(lrn_type_counts_df) <- c("lrn_type", "count")

# Calculate the total count
total_count <- sum(lrn_type_counts_df$count)

# Add a percentage column
lrn_type_counts_df <- lrn_type_counts_df %>%
  mutate(percentage = (count / total_count) * 100)

# Create the bar chart showing percentages
ggplot(lrn_type_counts_df, aes(x = lrn_type, y = percentage, fill = lrn_type)) +
  geom_bar(stat = "identity", color = "black", fill = "steelblue", show.legend = FALSE) + # Add border color and fill
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Adjust text size and angle for readability
        axis.title = element_text(size = 14), # Adjust axis title size
        title = element_text(size = 16), # Adjust plot title size
        panel.grid.major.x = element_blank(), # Remove x major grid lines for cleaner look
        panel.grid.minor = element_blank(), # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = "black"), # Background color
        plot.background = element_rect(fill = "white", color = NA)) + # Plot background color
  labs(title = "Percentage of Each Unique Learning Type",
       x = "Learning Type",
       y = "Percentage (%)")

# Calculate the average points earned for each lrn_type
avg_points_by_lrn_type <- sample_data_responses %>%
  group_by(lrn_type) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

# Create the bar plot
ggplot(avg_points_by_lrn_type, aes(x = lrn_type, y = avg_points_earned, fill = lrn_type)) +
  geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
  scale_fill_viridis_d() + # A professional color scale from the viridis package
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5)) + # Center the title for a professional look
  labs(title = "Average Points Earned by Learning Type",
       x = "Learning Type",
       y = "Average Points Earned")

# Calculate the average points earned for each lrn_type
avg_points_by_book <- sample_data_responses %>%
  group_by(book) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

ggplot(avg_points_by_book, aes(x = book, y = avg_points_earned, fill = book)) +
  geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
  scale_fill_viridis_d(begin = 0.3, end = 0.9, option = "C") + # A professional and accessible color scale
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank()) + # Hide the legend title
  labs(title = "Average Points Earned by Book",
       x = "Book",
       y = "Average Points Earned")

sample_data_responses$combined_column <- paste(sample_data_responses$chapter_number, sample_data_responses$section_number, sep = ".")

avg_points_by_combined <- sample_data_responses %>%
  group_by(combined_column) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

ggplot(avg_points_by_combined, aes(x = combined_column, y = avg_points_earned, fill = combined_column)) +
  geom_col() +
  scale_fill_viridis_d(begin = 0.3, end = 0.9, option = "C") + # Use a professional color scale
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8), # Adjust text for readability
        axis.title.x = element_blank(), # Since labels are self-explanatory
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") + # Hide legend for clarity
  labs(title = "Average Points Earned by Chapter.Section",
       y = "Average Points Earned")
```

```{r}
### Uninformed EDA

plot_avg_points_by_column <- function(data, column_name) {
  # First, ensure the column is treated as a factor for the plotting
  data <- data %>%
    mutate(!!sym(column_name) := as.factor(!!sym(column_name)))
  
  # Then, group by and summarise
  avg_points <- data %>%
    group_by(!!sym(column_name)) %>%
    summarise(avg_points_earned = mean(points_earned, na.rm = TRUE), .groups = 'drop')
  
  # Determine if the original column (before conversion) is numeric
  is_numeric <- is.numeric(data[[column_name]])
  
  # Plotting
  p <- ggplot(avg_points, aes(x = !!sym(column_name), y = avg_points_earned, fill = !!sym(column_name))) +
    geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = paste("Average Points Earned by", column_name),
         x = column_name,
         y = "Average Points Earned")
  
  # Apply appropriate color scale based on data type
  if (is_numeric) {
    p <- p + scale_fill_viridis_c()
  } else {
    p <- p + scale_fill_viridis_d()
  }
  
  print(p)
}

# Exclude multiple columns when iterating for plots
columns_to_exclude <- c("points_earned", "page", "points_possible", "dt_submitted", "completes_page", "lrn_response_id", "lrn_dt_started", "lrn_dt_saved", "lrn_status", "lrn_option_0", "lrn_option_1", "lrn_option_2", "lrn_option_3", "lrn_option_4", "lrn_option_5", "lrn_option_6", "lrn_option_7", "lrn_option_8", "lrn_option_9", "lrn_option_10", "lrn_option_11", "response", "prompt", "user_agent")
columns_of_interest <- setdiff(names(sample_data_responses), columns_to_exclude)

for(column_name in columns_of_interest) {
  plot_avg_points_by_column(sample_data_responses, column_name)
}
```

```{r}
filtered <- subset(df, !was_complete | !engaged)
engagement_by_chapter_and_institution <- filtered %>%
  group_by(chapter, institution_id) %>%
  summarise(mean_engaged = mean(engaged, na.rm = TRUE), median_engaged = median(engaged, na.rm = TRUE))

engagement_by_chapter_and_institution <- engagement_by_chapter_and_institution %>%
  arrange(median_engaged)

y_axis_limits <- quantile(engagement_by_chapter_and_institution$median_engaged, c(0.05, 0.95))

ggplot(engagement_by_chapter_and_institution, aes(x = chapter, y = median_engaged, color = factor(institution_id))) +
  geom_point() + 
  labs(title = "Engagement by Chapter and Institution", x = "Chapter", y = "Median Engaged") +
  scale_color_discrete(name = "Institution ID") +
  theme_minimal() +
  coord_cartesian(ylim = y_axis_limits)

ggplot(engagement_by_chapter_and_institution, aes(x = chapter, y = median_engaged, group = institution_id, color = factor(institution_id))) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(title = "Engagement by Chapter and Institution", x = "Chapter", y = "Median Engaged") +
  scale_color_discrete(name = "Institution ID") +
  theme_minimal()

institution_id_filtered_4 <- engagement_by_chapter_and_institution %>%
  filter(institution_id %in% c("d2e6c885-36f4-48b9-988b-42eef1f8ed9d", 
                               "364da48a-e0b2-4507-bc31-e7761fe 16e95", 
                               "94a809a9-a0ef-4c47-8d96-3a5ad76f674b",
                               "04157183-8665-400a-925d-3bbb70ffe45e"))

institution_id_filtered_3_1 <- engagement_by_chapter_and_institution %>%
  filter(institution_id %in% c("f17495c5-e105-492d-878a-07a03ea3f805", 
                               "fc5f1b1b-2aeb-4e09-93fc-06fdac0d8030", 
                               "94a809a9-a0ef-4c47-8d96-3a5ad76f674b"))



institution_id_filtered_3_2 <- engagement_by_chapter_and_institution %>%
  filter(institution_id %in% c("292cff87-3c74-4e94-8622-233afb0427dd", 
                               "2f830a93-5a14-4aff-a6e8-c7d2562e2007", 
                               "c699dd97-e5a4-49ce-9718-877a81b1d475"))

ggplot(institution_id_filtered_8, aes(x = chapter, y = median_engaged, group = institution_id, color = factor(institution_id))) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(title = "Engagement by Chapter and Institution", x = "Chapter", y = "Median Engaged") +
  scale_color_discrete(name = "Institution ID") +
  theme_minimal()

ggplot(institution_id_filtered_3_1, aes(x = chapter, y = median_engaged, group = institution_id, color = factor(institution_id))) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(title = "Engagement by Chapter and Institution", x = "Chapter", y = "Median Engaged") +
  scale_color_discrete(name = "Institution ID") +
  theme_minimal()

ggplot(institution_id_filtered_3_2, aes(x = chapter, y = median_engaged, group = institution_id, color = factor(institution_id))) +
  geom_smooth(method = "loess", se = FALSE) +
  labs(title = "Engagement by Chapter and Institution", x = "Chapter", y = "Median Engaged") +
  scale_color_discrete(name = "Institution ID") +
  theme_minimal()

# number_of_students_per_institution <- filtered %>%
#   group_by(page) %>%
#   count(institution_id)
# 
# merged <- inner_join(average_engagement_by_chapter_and_institution, number_of_students_per_institution, by=c("page", "institution_id"))
# merged <- mutate(merged, average = engaged / n)
# merged
```

```{r}
media_views$combined_column <- paste(media_views$chapter_number, media_views$section_number, sep = ".")
sorted_media_views <- media_views[order(media_views$combined_column), ]
combined_counts <- table(sorted_media_views$combined_column)
```