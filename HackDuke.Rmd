---
title: "HackDuke"
output: html_document
date: "`r Sys.Date()`"
---

```{r setup, include=FALSE}
if(!require(dplyr)) {install.packages("dplyr"); library(dplyr)}
if(!require(tidyverse)) {install.packages("tidyverse"); library(tidyverse)}
if(!require(rvest)) {install.packages("rvest"); library(rvest)}
if(!require(RSelenium)) {install.packages("RSelenium"); library(RSelenium)}
if(!require(wdman)) {install.packages("wdman"); library(wdman)}
if(!require(netstat)) {install.packages("netstat"); library(netstat)}
if(!require(xml2)) {install.packages("xml2"); library(xml2)}
if(!require(webdriver)) {install.packages("webdriver"); library(webdriver)}
if(!require(purrr)) {install.packages("purrr"); library(purrr)}
if (!require(here)) {install.packages("here"); library(here)}
if (!require(dotenv)) {install.packages("dotenv"); library(dotenv)}
if (!require(ggplot2)) {install.packages("ggplot2"); library(ggplot2)}
```

```{r data}
#data <- read.csv("./data/responses.csv")
sample_data_responses <- read.csv("./sample_data/responses.csv")
sample_data_mediaviews <- read.csv("./sample_data/media_views.csv")
```

```{r}
### Informed EDA

sample_rows_with_non_na <- apply(sample_data[, 29:40], 1, function(x) any(!is.na(x)))
sample_filtered_data <- sample_data[sample_rows_with_non_na, ]
lrn_type_counts <- table(sample_data_responses$lrn_type)
# Convert the table to a dataframe for ggplot2
lrn_type_counts_df <- as.data.frame(lrn_type_counts)

# Rename the columns for clarity
names(lrn_type_counts_df) <- c("lrn_type", "count")

# Calculate the total count
total_count <- sum(lrn_type_counts_df$count)

# Add a percentage column
lrn_type_counts_df <- lrn_type_counts_df %>%
  mutate(percentage = (count / total_count) * 100)

# Create the bar chart showing percentages
ggplot(lrn_type_counts_df, aes(x = lrn_type, y = percentage, fill = lrn_type)) +
  geom_bar(stat = "identity", color = "black", fill = "steelblue", show.legend = FALSE) + # Add border color and fill
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, size = 12), # Adjust text size and angle for readability
        axis.title = element_text(size = 14), # Adjust axis title size
        title = element_text(size = 16), # Adjust plot title size
        panel.grid.major.x = element_blank(), # Remove x major grid lines for cleaner look
        panel.grid.minor = element_blank(), # Remove minor grid lines
        panel.background = element_rect(fill = "white", colour = "black"), # Background color
        plot.background = element_rect(fill = "white", color = NA)) + # Plot background color
  labs(title = "Percentage of Each Unique Learning Type",
       x = "Learning Type",
       y = "Percentage (%)")

# Calculate the average points earned for each lrn_type
avg_points_by_lrn_type <- sample_data_responses %>%
  group_by(lrn_type) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

# Create the bar plot
ggplot(avg_points_by_lrn_type, aes(x = lrn_type, y = avg_points_earned, fill = lrn_type)) +
  geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
  scale_fill_viridis_d() + # A professional color scale from the viridis package
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5)) + # Center the title for a professional look
  labs(title = "Average Points Earned by Learning Type",
       x = "Learning Type",
       y = "Average Points Earned")

# Calculate the average points earned for each lrn_type
avg_points_by_book <- sample_data_responses %>%
  group_by(book) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

ggplot(avg_points_by_book, aes(x = book, y = avg_points_earned, fill = book)) +
  geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
  scale_fill_viridis_d(begin = 0.3, end = 0.9, option = "C") + # A professional and accessible color scale
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.title = element_blank()) + # Hide the legend title
  labs(title = "Average Points Earned by Book",
       x = "Book",
       y = "Average Points Earned")

sample_data_responses$combined_column <- paste(sample_data_responses$chapter_number, sample_data_responses$section_number, sep = ".")

avg_points_by_combined <- sample_data_responses %>%
  group_by(combined_column) %>%
  summarise(avg_points_earned = mean(points_earned, na.rm = TRUE))

ggplot(avg_points_by_combined, aes(x = combined_column, y = avg_points_earned, fill = combined_column)) +
  geom_col() +
  scale_fill_viridis_d(begin = 0.3, end = 0.9, option = "C") + # Use a professional color scale
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5, size = 8), # Adjust text for readability
        axis.title.x = element_blank(), # Since labels are self-explanatory
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        plot.title = element_text(hjust = 0.5),
        legend.position = "none") + # Hide legend for clarity
  labs(title = "Average Points Earned by Chapter.Section",
       y = "Average Points Earned")
```

```{r}
### Uninformed Responses EDA

plot_and_return_avg_points_table <- function(data, column_name) {
  # Ensure the column is treated as a factor
  data[[column_name]] <- as.factor(data[[column_name]])
  
  # Group by, summarise, and arrange the data
  avg_points <- data %>%
    group_by(!!sym(column_name)) %>%
    summarise(avg_points_earned = mean(points_earned, na.rm = TRUE), .groups = 'drop') %>%
    arrange(desc(avg_points_earned))

  # Convert the summarised column back to a factor with levels ordered by avg_points_earned for plotting
  avg_points[[column_name]] <- factor(avg_points[[column_name]], levels = avg_points[[column_name]])
  
  # Determine if the original column (before conversion) is numeric for plotting
  is_numeric <- is.numeric(data[[column_name]])
  
  # Plotting
  p <- ggplot(avg_points, aes(x = reorder(!!sym(column_name), avg_points_earned), y = avg_points_earned, fill = !!sym(column_name))) +
    geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = paste("Average Points Earned by", column_name),
         x = column_name,
         y = "Average Points Earned")

  # Apply appropriate color scale based on data type
  if (is_numeric) {
    p <- p + scale_fill_viridis_c()
  } else {
    p <- p + scale_fill_viridis_d()
  }
  
  print(p)
  
  # Return the data table
  return(avg_points)
}


# Exclude multiple columns when iterating for plots
columns_to_exclude <- c("points_earned", "page", "points_possible", "dt_submitted", "completes_page", "lrn_response_id", "lrn_dt_started", "lrn_dt_saved", "lrn_status", "lrn_option_0", "lrn_option_1", "lrn_option_2", "lrn_option_3", "lrn_option_4", "lrn_option_5", "lrn_option_6", "lrn_option_7", "lrn_option_8", "lrn_option_9", "lrn_option_10", "lrn_option_11", "response", "prompt", "user_agent")
columns_of_interest <- setdiff(names(sample_data_responses), columns_to_exclude)

avg_points_tables <- list()

for(column_name in columns_of_interest) {
  # Now calling the correct function that returns a table
  avg_points_table <- plot_and_return_avg_points_table(sample_data_responses, column_name)
  
  # Store the table in a list for later use
  avg_points_tables[[column_name]] <- avg_points_table
}
avg_points_tables
```

```{r}
### Chapter, Sections with video
sample_data_mediaviews$combined_column <- paste(sample_data_mediaviews$chapter_number, sample_data_mediaviews$section_number, sep = ".")
sorted_media_views <- sample_data_mediaviews[order(sample_data_mediaviews$combined_column), ]
combined_counts <- table(sorted_media_views$combined_column)
combined_percentages <- (combined_counts / sum(combined_counts)) * 100
combined_percentage_df <- data.frame(
  combined_column = names(combined_percentages),
  percentage = combined_percentages
)
combined_percentage_df <- combined_percentage_df[-2]
combined_percentage_df
```

```{r}
### Pulse Rating vs. Average Score

sample_data_checkpoints <- read.csv("./sample_data/checkpoints.csv")
plot_and_return_avg_points_table <- function(data, column_name) {
  # Ensure the column is treated as a factor
  data[[column_name]] <- as.factor(data[[column_name]])
  
  # Group by, summarise, and arrange the data
  avg_points <- data %>%
    group_by(!!sym(column_name)) %>%
    summarise(avg_points_earned = mean(points_earned, na.rm = TRUE), .groups = 'drop') %>%
    arrange(desc(avg_points_earned))

  # Convert the summarised column back to a factor with levels ordered by avg_points_earned for plotting
  avg_points[[column_name]] <- factor(avg_points[[column_name]], levels = avg_points[[column_name]])
  
  # Determine if the original column (before conversion) is numeric for plotting
  is_numeric <- is.numeric(data[[column_name]])
  
  # Plotting
  p <- ggplot(avg_points, aes(x = reorder(!!sym(column_name), avg_points_earned), y = avg_points_earned, fill = !!sym(column_name))) +
    geom_bar(stat = "identity", color = "black", show.legend = FALSE) +
    theme_minimal() +
    theme(axis.text.x = element_text(angle = 45, hjust = 1),
          panel.grid.major = element_blank(),
          panel.grid.minor = element_blank(),
          plot.title = element_text(hjust = 0.5)) +
    labs(title = paste("Average Points Earned by", column_name),
         x = column_name,
         y = "Average Points Earned")

  # Apply appropriate color scale based on data type
  if (is_numeric) {
    p <- p + scale_fill_viridis_c()
  } else {
    p <- p + scale_fill_viridis_d()
  }
  
  print(p)
  
  # Return the data table
  return(avg_points)
}


# Exclude multiple columns when iterating for plots
columns_to_exclude <- c("points_earned", "page", "points_possible", "dt_submitted", "completes_page", "lrn_response_id", "lrn_dt_started", "lrn_dt_saved", "lrn_status", "lrn_option_0", "lrn_option_1", "lrn_option_2", "lrn_option_3", "lrn_option_4", "lrn_option_5", "lrn_option_6", "lrn_option_7", "lrn_option_8", "lrn_option_9", "lrn_option_10", "lrn_option_11", "response", "prompt", "user_agent")
columns_of_interest <- setdiff(names(sample_data_responses), columns_to_exclude)

avg_points_tables <- list()

for(column_name in columns_of_interest) {
  # Now calling the correct function that returns a table
  avg_points_table <- plot_and_return_avg_points_table(sample_data_responses, column_name)
  
  # Store the table in a list for later use
  avg_points_tables[[column_name]] <- avg_points_table
}
avg_points_tables
```
